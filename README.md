# WASM demo: Javascript in Python 

Install esbuild for nodejs

```
npm install esbuild
```

Install wasmtime for python

```
pip install wasmtime
```

Bundle JS w/ esbuild

```
./node_modules/.bin/esbuild obfuscate.js --bundle --outfile=obfuscate.bundle.js --platform=browser --target=es6 --format=esm
```

Generate WASM from WIT + JS

```
node componentize.mjs
```

Generate Python bindings from WIT

```py
python3.10 -m wasmtime.bindgen obfuscate.component.wasm --out-dir obfuscate
```

Run it!

```py
python3.10 obfuscate.py socket.js
```

It works.

```
▶ make run
Python wasm: 0.198s
Node inner:  0.072s
Python node: 0.193s
```

## Modifying for production

The code generated by wasmtime.bindgen creates a single reusable instance.
That won't work for us because if you try to run it a bunch of times, it will crash.

```py
for x in range(100):
    out = demo.obfuscate(store, src)
```

Crashes with

```
Traceback (most recent call last):
  File "/mnt/f/web/junk/wasm-py/obfuscate.py", line 25, in <module>
    main()
  File "/mnt/f/web/junk/wasm-py/obfuscate.py", line 14, in main
    out = demo.obfuscate(store, src)
  File "/mnt/f/web/junk/wasm-py/obfuscate/__init__.py", line 28, in obfuscate
    ret = self.lift_callee0(caller, ptr, len0)
  File "/home/kev/.local/lib/python3.10/site-packages/wasmtime/_func.py", line 91, in __call__
    with enter_wasm(store) as trap:
  File "/usr/lib/python3.10/contextlib.py", line 142, in __exit__
    next(self.gen)
  File "/home/kev/.local/lib/python3.10/site-packages/wasmtime/_func.py", line 264, in enter_wasm
    raise trap_obj
wasmtime._trap.Trap: error while executing at wasm backtrace:
    0: 0x2a83e8 - <unknown>!<wasm function 329>
    1: 0x4ffad7 - <unknown>!<wasm function 3301>
    2: 0x3da468 - <unknown>!<wasm function 1137>
    3: 0x33703e - <unknown>!<wasm function 603>
    4: 0x57f91f - <unknown>!obfuscate

Caused by:
    0: memory fault at wasm address 0x4b4b4b4b in linear memory of size 0x4310000
    1: wasm trap: out of bounds memory access
make: *** [Makefile:7: run] Error 1
```

### Alteration

Instead, we need to create a new instance of the module on invocation (see `obfuscator.py`).

```py
class Obfuscator:

    def __init__(self) -> None:
        path = pathlib.Path(__file__).parent / ('obfuscate/root.core0.wasm')
        self._store = wasmtime.Store()
        self._module = wasmtime.Module.from_file(self._store.engine, path)
    def obfuscate(self, src: str) -> str:
        instance = wasmtime.Instance(self._store, self._module, []).exports(self._store)
        memory = instance["memory"]
        realloc = instance["cabi_realloc"]
        lift_callee = instance["obfuscate"]
        ptr, len0 = _encode_utf8(src, realloc, memory, self._store)
        ret = lift_callee(self._store, ptr, len0)
        load = _load(ctypes.c_int32, memory, self._store, ret, 0)
        load1 = _load(ctypes.c_int32, memory, self._store, ret, 4)
        ptr2 = load
        len3 = load1
        list = _decode_utf8(memory, self._store, ptr2, len3)
        del instance
        return list

```

This turns out to be just as fast as using a single instance because the module is still only compiled once.

```
▶ make run
Python wasm: 0.221s
Node inner:  0.072s
Python node: 0.208s
```

### Further investigation

- Does this work for multi-megabyte js files?
- Does this work for js using es6 features?
